{% extends 'base.html' %}
{% load product_filters %}
{% block title %}{{ product.name }} - Store{% endblock %}

{% block content %}
<div class="animate-fade-up">
    <!-- Breadcrumbs -->
    <nav class="flex mb-8 text-sm" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2">
            <li><a href="/" style="color: var(--text-muted);" class="hover:underline">Home</a></li>
            <li class="flex items-center space-x-2">
                <span style="color: var(--text-muted);">/</span>
                <a href="{% url 'product_list_by_category' product.category.slug %}" style="color: var(--text-muted);" class="hover:underline">{{ product.category.name }}</a>
            </li>
            <li class="flex items-center space-x-2">
                <span style="color: var(--text-muted);">/</span>
                <span style="color: var(--text-primary);" class="font-medium">{{ product.name }}</span>
            </li>
        </ol>
    </nav>

    <div class="flex flex-col md:flex-row gap-12 lg:gap-20 items-start">
        <!-- Product Image -->
        <div class="w-full md:w-1/2 sticky md:top-24">
            <div class="aspect-square rounded-2xl overflow-hidden relative" style="background: var(--bg-soft);">
                {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full flex flex-col items-center justify-center" style="color: var(--text-muted);">
                    <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                </div>
                {% endif %}
                {% if product.discount_price %}
                <span class="sale-badge !top-4 !left-4">Sale!</span>
                {% endif %}
            </div>
        </div>

        <!-- Product Info -->
        <div class="w-full md:w-1/2 space-y-6">
            <div>
                <p class="text-xs font-medium tracking-widest uppercase mb-3" style="color: var(--accent);">{{ product.category.name }}</p>
                <h1 class="text-3xl sm:text-4xl font-bold tracking-tight" style="color: var(--text-primary);">{{ product.name }}</h1>
            </div>

            <div class="flex items-center gap-3">
                {% if product.discount_price %}
                <span class="text-2xl font-bold" style="color: var(--text-primary);">${{ product.discount_price }}</span>
                <span class="text-lg line-through" style="color: var(--text-muted);">${{ product.price }}</span>
                <span class="text-xs font-medium px-2.5 py-1 rounded-full" style="background: var(--accent-light); color: var(--accent);">
                    Save ${{ product.price|subtract:product.discount_price|default:0 }}
                </span>
                {% else %}
                <span class="text-2xl font-bold" style="color: var(--text-primary);">${{ product.price }}</span>
                {% endif %}
            </div>

            <div class="text-sm leading-relaxed" style="color: var(--text-secondary);">
                <p>{{ product.description }}</p>
            </div>

            <div class="pt-2" style="border-top: 1px solid var(--border);">
                {% if request.user == product.seller or request.user.is_superuser %}
                <div class="mb-6 p-5 rounded-2xl animate-fade-up" style="background: var(--bg); border: 1px solid var(--border); box-shadow: var(--shadow-sm);">
                    <p class="text-xs font-bold tracking-widest uppercase mb-4" style="color: var(--text-muted);">Seller Management</p>
                    <div class="flex flex-col gap-3">
                        <a href="{% url 'seller_dashboard' %}" class="w-full py-2 px-4 rounded-xl text-center text-sm font-medium transition-colors border" style="color: var(--accent); border-color: var(--accent); background: var(--accent-light);">
                            Go to Dashboard
                        </a>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <form action="{% url 'product_toggle_stock' product.id %}" method="post" class="flex-1">
                                {% csrf_token %}
                                {% if product.stock > 0 %}
                                <button type="submit" class="w-full py-3 px-4 rounded-xl text-sm font-medium transition-colors border" style="background: #fff8f1; color: #ea580c; border-color: #ffedd5;">
                                    Mark Out of Stock
                                </button>
                                {% else %}
                                <button type="submit" class="w-full py-3 px-4 rounded-xl text-sm font-medium transition-colors border" style="background: #f0fdf4; color: #16a34a; border-color: #dcfce7;">
                                    Mark In-Stock
                                </button>
                                {% endif %}
                            </form>
                            <button type="button" onclick="document.getElementById('deleteModal').classList.replace('hidden', 'flex')" class="w-full sm:w-1/2 py-3 px-4 rounded-xl text-sm font-medium transition-colors border" style="background: #fee2e2; color: #dc2626; border-color: #fca5a5;">
                                Delete Product
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}

                <form action="{% url 'cart:cart_add' product.id %}" method="post" class="space-y-4">
                    {% csrf_token %}
                    <div class="flex items-center gap-4">
                        <div class="flex items-center rounded-full px-1 py-1" style="border: 1px solid var(--border);">
                            <input type="number" name="quantity" value="1" min="1" max="{{ product.stock }}" class="w-14 text-center text-sm font-medium outline-none border-none bg-transparent" style="color: var(--text-primary);">
                        </div>
                        <p class="text-xs font-medium {% if product.stock > 0 %}text-emerald-600{% else %}text-red-500{% endif %}">
                            {% if product.stock > 0 %}In Stock ({{ product.stock }}){% else %}Out of Stock{% endif %}
                        </p>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary flex-grow justify-center !py-3.5">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            Add to Cart
                        </button>
                        <button class="btn-outline !py-3.5 !px-4" type="button">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- You May Also Like (full width, below product row) -->
    {% if related_products %}
    <div class="mt-20">
        <h3 class="section-title mb-8">You May Also Like</h3>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-5 lg:gap-6">
            {% for rp in related_products %}
            <div class="product-card group">
                <a href="{{ rp.get_absolute_url }}">
                    <div class="product-image">
                        {% if rp.image %}
                        <img src="{{ rp.image.url }}" alt="{{ rp.name }}">
                        {% endif %}
                    </div>
                    <div class="product-info">
                        <p class="product-category">{{ rp.category.name }}</p>
                        <h4 class="product-name truncate">{{ rp.name }}</h4>
                        <p class="product-price">${{ rp.price }}</p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if request.user == product.seller or request.user.is_superuser %}
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity">
        <div class="p-6 md:p-8 rounded-2xl max-w-sm w-full mx-4 shadow-2xl transform transition-transform" style="background: var(--bg); border: 1px solid var(--border);">
            <div class="flex items-center gap-3 mb-4 text-red-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <h3 class="text-xl font-bold">Delete Product?</h3>
            </div>
            <p class="text-sm mb-6" style="color: var(--text-secondary);">Are you absolutely sure you want to permanently delete <strong>{{ product.name }}</strong>? This action cannot be undone.</p>
            <div class="flex flex-col gap-3">
                <div class="flex gap-4 border-t pt-5 mt-2" style="border-color: var(--border);">
                    <button type="button" onclick="document.getElementById('deleteModal').classList.replace('flex', 'hidden')" class="flex-1 py-3 px-4 rounded-xl font-medium text-sm border hover:opacity-80 transition-opacity" style="color: var(--text-primary); border-color: var(--border);">
                        Cancel
                    </button>
                    <form action="{% url 'product_delete' product.id %}" method="post" class="flex-1">
                        {% csrf_token %}
                        <button type="submit" class="w-full py-3 px-4 rounded-xl font-medium text-sm text-white transition-opacity hover:opacity-90" style="background: #dc2626;">
                            Yes, Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
